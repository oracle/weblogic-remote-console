{"version":3,"file":"SeleniumDriver.cjs","sources":["../../src/UNSAFE_SeleniumDriver/SeleniumDriver.ts"],"sourcesContent":["import {\n  type ClickOptions,\n  type KeyType,\n  TestDriverBase,\n  type TestElement,\n  getTimeouts\n} from '@oracle/oraclejet-testing/UNSAFE_Driver';\nimport { Keys as TestingKeys } from '@oracle/oraclejet-testing/UNSAFE_Driver';\nimport { ElementLocator } from '@oracle/oraclejet-testing/UNSAFE_Locators';\nimport { By, Key as WebDriverKeys, WebDriver, WebElement } from 'selenium-webdriver';\n\ntype WaitForElementType = (\n  locator: ElementLocator,\n  parent: WebDriver | WebElement\n) => Promise<TestElement>;\n\ntype WaitForElementsType = (\n  locator: ElementLocator,\n  parent: WebDriver | WebElement\n) => Promise<TestElement[]>;\n\nconst modifierKeys = {\n  SHIFT: WebDriverKeys.SHIFT,\n  CONTROL: WebDriverKeys.CONTROL,\n  CONTROL_COMMAND: WebDriverKeys.CONTROL,\n  ALT: WebDriverKeys.ALT\n};\n\nconst keyMap: { [key: string]: string } = {\n  ...modifierKeys,\n  BACKSPACE: WebDriverKeys.BACK_SPACE,\n  TAB: WebDriverKeys.TAB,\n  ENTER: WebDriverKeys.ENTER,\n  ESCAPE: WebDriverKeys.ESCAPE,\n  PAGE_UP: WebDriverKeys.PAGE_UP,\n  PAGE_DOWN: WebDriverKeys.PAGE_DOWN,\n  END: WebDriverKeys.END,\n  HOME: WebDriverKeys.HOME,\n  ARROW_LEFT: WebDriverKeys.ARROW_LEFT,\n  ARROW_UP: WebDriverKeys.ARROW_UP,\n  ARROW_RIGHT: WebDriverKeys.ARROW_RIGHT,\n  ARROW_DOWN: WebDriverKeys.ARROW_DOWN,\n  DELETE: WebDriverKeys.DELETE,\n\n  F1: WebDriverKeys.F1,\n  F2: WebDriverKeys.F2,\n  F3: WebDriverKeys.F3,\n  F4: WebDriverKeys.F4,\n  F5: WebDriverKeys.F5,\n  F6: WebDriverKeys.F6,\n  F7: WebDriverKeys.F7,\n  F8: WebDriverKeys.F8,\n  F9: WebDriverKeys.F9,\n  F10: WebDriverKeys.F10,\n  F11: WebDriverKeys.F11,\n  F12: WebDriverKeys.F12\n};\n\nlet currentScriptTimeout: number | undefined;\n\nexport class SeleniumDriver extends TestDriverBase {\n  private _driver: WebDriver;\n  private _platform = '';\n\n  constructor(driver: WebDriver) {\n    super();\n    this._driver = driver;\n  }\n\n  async executeScript<T>(script: string | ((...args: any) => T), ...args: any): Promise<T> {\n    await this._setDriverTimeouts();\n    return this._driver.executeScript<T>(script, ...args);\n  }\n\n  async waitForElement(locator: ElementLocator): Promise<TestElement> {\n    return this._waitForElement(locator, this._driver);\n  }\n\n  async waitForElements(locator: ElementLocator): Promise<TestElement[]> {\n    return this._waitForElements(locator, this._driver);\n  }\n\n  private _waitForElement = async (locator: ElementLocator, parent: WebDriver | WebElement) => {\n    try {\n      const el = await this.waitFor<Promise<WebElement>>(\n        () => parent.findElement(By.css(locator.css)),\n        {\n          timeout: getTimeouts().elementExistsTimeout\n        }\n      );\n      return Promise.resolve(wrapElement(el, this._waitForElement, this._waitForElements));\n    } catch {\n      throw Error(`No element matching query \"${JSON.stringify(locator)}\"`);\n    }\n  };\n\n  private _waitForElements = async (locator: ElementLocator, parent: WebDriver | WebElement) => {\n    let matches: WebElement[] | undefined;\n    try {\n      // loop to find at least 1 match\n      matches = await this.waitFor<WebElement[] | undefined>(\n        async () => {\n          const all = await parent.findElements(By.css(locator.css));\n          if (all.length) {\n            return all;\n          }\n          return;\n        },\n        {\n          timeout: getTimeouts().elementExistsTimeout\n        }\n      );\n    } catch {\n      return [];\n    }\n    return Promise.resolve(\n      Array.from(matches || []).map((m) =>\n        wrapElement(m, this._waitForElement, this._waitForElements)\n      )\n    );\n  };\n\n  /**\n   * Get a TestElement for the given WebElement\n   * @param from The WebElement\n   * @returns A TestElement\n   */\n  getTestElement(from: WebElement) {\n    return wrapElement(from, this._waitForElement, this._waitForElements);\n  }\n\n  async sendKeys(element: TestElement, ...text: (string | KeyType)[]): Promise<void> {\n    await this._ensurePlatform();\n    return this.unwrapElement(element).sendKeys(\n      ...text.map<string>(this._getPlatformKey.bind(this))\n    );\n  }\n\n  async click(element: TestElement, options: ClickOptions = {}) {\n    await this._ensurePlatform();\n    const modifiers = options.modifiers || [];\n    const actions = this._driver.actions();\n    if (modifiers) {\n      modifiers.map(this._getPlatformKey.bind(this)).forEach((m) => actions.keyDown(m));\n      await actions.perform();\n    }\n    await this.unwrapElement(element).click();\n    return actions.clear();\n  }\n\n  unwrapElement<T = WebElement>(element: TestElement): T {\n    return (element as TestElementImpl)._el as T;\n  }\n\n  private async _ensurePlatform() {\n    if (!this._platform) {\n      this._platform = (await this._driver.getCapabilities()).getPlatform() || 'unknown';\n    }\n  }\n\n  /**\n   * Get the platform-specific key value for the key, if available.\n   * @param key The key value\n   * @returns A platform-specific value for the key, or the original key if none exists\n   */\n  private _getPlatformKey(key: string | KeyType) {\n    if (typeof key === 'object') {\n      return TestingKeys.CONTROL_COMMAND === key\n        ? this._platform === 'mac'\n          ? WebDriverKeys.COMMAND\n          : WebDriverKeys.CONTROL\n        : keyMap[key.key];\n    }\n    return key;\n  }\n\n  private _setDriverTimeouts() {\n    const { scriptTimeout } = getTimeouts();\n    if (scriptTimeout !== currentScriptTimeout) {\n      currentScriptTimeout = scriptTimeout;\n      // set script timeout\n      // we don't set implicit (waitForElement) because we want to enforce our own behavior\n      return this._driver.manage().setTimeouts({\n        script: scriptTimeout\n      });\n    }\n    return;\n  }\n}\n\nfunction wrapElement(\n  element: WebElement,\n  waitForElement: WaitForElementType,\n  waitForElements: WaitForElementsType\n) {\n  return new TestElementImpl(element, waitForElement, waitForElements);\n}\n\nclass TestElementImpl implements TestElement {\n  _el: WebElement;\n  _waitForElement: WaitForElementType;\n  _waitForElements: WaitForElementsType;\n\n  constructor(\n    element: WebElement,\n    waitForElement: WaitForElementType,\n    waitForElements: WaitForElementsType\n  ) {\n    this._el = element;\n    this._waitForElement = waitForElement;\n    this._waitForElements = waitForElements;\n  }\n  waitForElement(locator: ElementLocator): Promise<TestElement> {\n    return this._waitForElement(locator, this._el);\n  }\n  waitForElements(locator: ElementLocator): Promise<TestElement[]> {\n    return this._waitForElements(locator, this._el);\n  }\n  getAttribute(attrName: string): Promise<string | null> {\n    return this._el.getAttribute(attrName);\n  }\n}\n"],"names":["WebDriverKeys","TestDriverBase","By","getTimeouts","TestingKeys"],"mappings":"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"}