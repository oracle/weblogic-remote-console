import { OjStreamListBase } from './OjStreamListBase';
import { By, WebElement } from 'selenium-webdriver';

/**
 * The component WebElement for [oj-stream-list](../../jsdocs/oj.ojStreamList.html).
 * Do not instantiate this class directly, instead, use
 * [ojStreamList](../functions/elements.ojStreamList-1.html).
 */
export class OjStreamList extends OjStreamListBase {
  // Put overrides here
  async findItem<T extends string | number>(itemLocator: {
    key?: T;
    parentKey?: T;
  }): Promise<WebElement> {
    const items = await this.findElements(By.css('.oj-stream-list-item, .oj-stream-list-group'));
    await this.whenBusyContextReady();
    return this.getDriver().executeScript(
      ({ key, parentKey }: typeof itemLocator, items: HTMLElement[]) => {
        let el;
        const getParentKey = function (item: any | null) {
          while (item) {
            if (item.classList.contains('oj-stream-list-group')) {
              const ojKeyType = item.dataset['ojKeyType'];
              const ojKey = item.dataset['ojKey'];
              return ojKeyType === 'number' ? Number(ojKey) : ojKey;
            }
            item = item.previousElementSibling;
          }
          return null;
        };
        for (let i = 0; i < items.length; i++) {
          let item = items[i];
          const ojKeyType = item.dataset['ojKeyType'];
          const ojKey = item.dataset['ojKey'];
          const itemKey = ojKeyType === 'number' ? Number(ojKey) : ojKey;
          if (itemKey === key) {
            if (parentKey == null || getParentKey(item) === parentKey) {
              el = item;
            }
          }
        }
        return el;
      },
      itemLocator,
      items
    );
  }

  async findGroup<T extends string | number>(itemLocator: { key?: T }): Promise<WebElement> {
    const items = await this.findElements(By.css('.oj-stream-list-group'));
    await this.whenBusyContextReady();

    const group = this.getDriver().executeScript<WebElement>(
      (key: T, items: any[]) => {
        return items.find((item) => {
          const ojKeyType = item.dataset['ojKeyType'];
          const ojKey = item.dataset['ojKey'];
          const itemKey = ojKeyType === 'number' ? Number(ojKey) : ojKey;
          return itemKey === key;
        });
      },
      itemLocator.key,
      items
    );
    return group;
  }
}
