import { OjSelectOneBase } from './OjSelectOneBase';
import { executeWithModules } from '../../lib/oj-module-proxy';

/**
 * The component WebElement for [oj-select-one](../../jsdocs/oj.ojSelectOne.html).
 * Do not instantiate this class directly, instead, use
 * [ojSelectOne](../functions/elements.ojSelectOne-1.html).
 */
export class OjSelectOne extends OjSelectOneBase {
  /**
   * Sets the value of "value" property.
   * The value of the element.
   * @param value The value to set for "value"
   * @override
   */
  async changeValue(value: any) {
    // Only mutate if not readonly/disabled
    const readonly = await this.getReadonly();
    const disabled = await this.getDisabled();
    if (!(readonly || disabled)) {
      await this.getDriver().executeScript((element: HTMLElement) => element.focus(), this);
      await this.whenBusyContextReady();
      const isValueSet = await executeWithModules<boolean>(
        this.getDriver(),
        ['CustomElementUtils'],
        [this, value],
        ({ getElementBridge }, element, value) => {
          // Retrieve the widget instance from the element
          var bridge = getElementBridge(element);
          var widget = bridge._WIDGET_INSTANCE.select;
          return widget
            ._selectItemByValue(value)
            .then(() => true)
            .catch(() => false);
        }
      );

      // If failed to set value, fallback to setProperty
      if (isValueSet === false) {
        console.warn('Failed to update value by interaction. Falling back to setProperty.');
        await this._changeValueFallback(value);
      }
    }
  }

  /**
   * Clears the value
   * @override
   */
  clear(): Promise<void> {
    return this.setProperty<any>('value', null);
  }

  /**
   * This is a fallback mechanism for setting a value which
   * uses the setProperty method to update the value.
   *
   * @param value The value to be set
   */
  private _changeValueFallback(value: any): Promise<void> {
    return this.setProperty<any>('value', value);
  }
}
