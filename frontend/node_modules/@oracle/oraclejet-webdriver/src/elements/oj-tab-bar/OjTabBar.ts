import { error, WebElement } from 'selenium-webdriver';
import { OjTabBarBase } from './OjTabBarBase';
import { executeWithModules } from '../../lib/oj-module-proxy';

/**
 * The component WebElement for [oj-tab-bar](../../jsdocs/oj.ojTabBar.html).
 * Do not instantiate this class directly, instead, use
 * [ojTabBar](../functions/elements.ojTabBar-1.html).
 */
export class OjTabBar extends OjTabBarBase {
  /**
   * Remove a tab specific by the key
   * @param key key of the tab to be removed
   * If the key is not found, an error will be thrown
   * @override
   * @typeparam K Type of keys
   */
  async doRemove<K>(key: K): Promise<void> {
    await this.whenReady();
    const tab = await this.getDriver().executeScript<WebElement>(
      (ele: any, key: K) => ele.getNodeBySubId({ subId: 'oj-tabbar-item', key }),
      this,
      key
    );
    if (tab != null) {
      await executeWithModules<void>(
        this.getDriver(),
        ['CustomElementUtils'],
        [this, tab],
        ({ getElementBridge }, element, tab) => {
          const bridge = getElementBridge(element);
          const widget = bridge._WIDGET_INSTANCE;
          return widget.navlist._fireRemoveEvent(null, [tab]);
        }
      );
    } else {
      return Promise.reject(
        new error.InvalidArgumentError(`Tab with specified key cannot be found`)
      );
    }
  }

  /**
   * Moves tab specified by key then put the tab to the specified place
   * @param key key of the tab to be reordered
   * If the key is not found, an error will be thrown
   * @param position the index or the key of the tab that user want to move in front of, if the key is null, the tab will move to the end of the tab bar
   * If the key or the index of the position is not found, an error will be thrown
   * @override
   * @typeparam K Type of keys
   * @typeparam number Type of index
   */
  async doReorder<K>(key: K, position: { index: number } | { key: K | null }): Promise<void> {
    await this.whenReady();
    await executeWithModules<void>(
      this.getDriver(),
      ['CustomElementUtils'],
      [this, key, position],
      ({ getElementBridge }, element, key, position) => {
        const bridge = getElementBridge(element);
        const widget = bridge._WIDGET_INSTANCE;
        return widget.navlist._doReorderHelper(null, key, position);
      }
    );
  }
}
