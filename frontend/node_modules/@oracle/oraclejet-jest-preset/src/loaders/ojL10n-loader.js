// This loader mimics ojL10n's behavior of returning the contents of the 'root'
// property from JET bundles.

const vm = require('vm');

/*
 * Create a context in which the resource bundle's script will run.
 * AMD resource bundles are defined in one of two structures:
 * - define({ resource_keys... })
 * - define(['require', 'exports'], function(require, exports) { })
 *
 * For the 2nd structure (with callback), the resource bundle can be returned
 * from the callback or assigned to the "exports" parameter.
 *
 * Return the bundle from our define() so that it can be uniformly extracted
 */
const context = vm.createContext({
  define: function(rb) {
    // define({ ... })
    if (arguments.length === 1) {
      return typeof rb === 'function' ? rb() : rb;
    }
    // define(['require', 'exports'], function(require, exports))
    const exp = {};
    // pass exports for every argument
    const args = new Array(arguments[0].length);
    const ret = arguments[1](...args.fill(exp));
    // AMD may return the value or assign to 'exports'
    const resource = ret || exp;
    return resource.default || resource;
  }
});

module.exports = {
  process(content, filename) {
    // "content" is the resource bundle's script source
    // Since the script runs in our context, assign it to "this.rb" so that we
    // can retrieve it
    const script = new vm.Script(`this.rb = ${content}`);
    try {
      // Run in try/catch to process only AMD files. All other file types (CJS)
      // will throw exception
      script.runInContext(context);
      // app resource bundles are underneath 'root'
      // otherwise return entire bundle
      const bundle = context.rb.root || context.rb;
      bundle._ojLocale_ = 'en';
      return {
        code: `module.exports = ${JSON.stringify(context.rb.root || context.rb)}`
      };
    } catch (ex) {}
    return {
      code: content
    };
  }
}
